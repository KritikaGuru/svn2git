#
# talloc.icn -- thread allocation report test
#

global thrd

procedure main(argv)
   if not (&features == "concurrent threads") then
      stop("This program requires concurrent threads.")

   thrd:=[]

   if *argv>0 then
      n:=integer(argv[1]) | stop ("arg must be integer")
    else
       n:=4
   
   every i := !n do put(thrd, create talloc(i))
   every spawn(!thrd, 1M, 100K, 1M)
   # pick up the results from all threads
   write("talloc test: if everything goes well nothing else will be printed")
   r1:= <<@pop(thrd)
   every write( r1 ~= (r2 := <<@!thrd))

end

procedure talloc(id)
    y := keyword("tallocated")
	
    every i := !4  do {
       x := list(8)
       x := table(4)
       }

    # get the current thread allocation,
    # i.e &allocated for the current thread
    # queue up the result to be picked by &main
    keyword("tallocated") @>>
    collect()
end
    
