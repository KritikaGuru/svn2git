#
# talloc.icn -- thread allocation report test
#

global thrd

procedure main(argv)
   if not (&features == "concurrent threads") then
      stop("This program requires concurrent threads.")

   thrd:=[]

   if *argv>0 then
      n:=integer(argv[1]) | stop ("arg must be integer")
    else
       n:=4
   
   every i := !n do put(thrd, create talloc(i))
   every spawn(!thrd, 1M, 100K, 1M)
   # pick up the results from all threads
   every write( <<@!thrd )
   #write("tot=", &allocated)
end

procedure talloc(id)
    y := keyword("tallocated")
	
    every i := !16  do {
       x := list(id * i)
       x := table(id * i)
       }

    # get the current thread allocation,
    # i.e &allocated for the current thread
    # queue up the result to be picked by &main
    ("Thread " || id || " strated with " || y || " bytes and allocated " || keyword("tallocated") || " bytes") @>>
    delay(100)
end
    
