#
# long run program that is carpage collection intensive
#

global gsum, mutex_gsum


procedure main(argv)
   gsum:=0
   thrd:=[]

   if *argv>0 then
      n:=integer(argv[1]) | stop ("arg must be integer")
    else
      n:=1
  
   d:=10^7 / n
   every i:=1 to n do{
     th := create suma(d, i)
     put(thrd, th)
     }

   mutex_gsum := mutex()
  
   write("running ", *thrd , " thread(s) please wait... ")

   t:=&now
   every i:=1 to *thrd do
      thread(thrd[i])

   every i:=1 to *thrd do
      wait(thrd[i])

   write("sum=",gsum)
   
   write("time:", &now-t, " seconds")
end


procedure suma(n, id)                                                                        
local sum, L, T, S                                                                        
sum:=0                                                                                   

every i:=1 to n do{                                                                      
   sum+:=1                                                                                
   if i%100=1 then{                                                                       
      L:=[]                                                                              
      T:=table()                                                                         
      S:=set()                                                                           
   }                                                                                      
   
   put(L, i)                                                                              
   T[i]:=sum                                                                              
   insert(S, i, sum)                                                                      
}                                                                                          

lock(mutex_gsum)                                                                          
gsum +:= sum                                                                              
unlock(mutex_gsum)                                                                        

write("Thread ", id , " is done")                                                         
end                                                                                          



procedure oldsuma(n, id)
   local sum
    sum:=0
    every i:=1 to n do
      sum+:=1

   lock(mutex_gsum)
   gsum +:= sum
   unlock(mutex_gsum)

   write("Thread ", id , " is done")
end
