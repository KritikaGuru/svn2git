#
# This test illustrates how lists must be protected from race 
# conditions with multi-thread.
#
global L
procedure main()
   if not (&features == "concurrent threads") then
       stop("requires concurrent threads")
   n := 3
   L := mutex( [ ] )
   
   write ("firing threads...")
   threads := []
   every i := !n do
       put(threads, thread work(i))
   
   every wait(!threads)
   write("We just did 3,000,000 calls to put() from three threads\n",
	 "The list was protected by a mutex.\n",
	 "How many elements do we have?")
   write(*L)

end

procedure work(i)
    every j := 1 to 1000000 do put(L, j^i)
end
