############################################################################
#
#	File:     run-benchmark.icn
#
#	Subject:  Run Unicon Benchmarks with "small" n
#
#	Author:   Shea Newton
#
#	Date:     January 3, 2014
#
############################################################################
#
#   This file is in the public domain.
#
############################################################################
#
#   Compile and run without arguments to run entire suite or
#   specify as runtime arguments which benchmarks to run.
#
############################################################################
link "auxiliary" 

$ifdef _UNIX
$define NUL "/dev/null"
$else
   $define NUL "\\nul"
$endif

global output

procedure main(argv)
   local rL, tL, concurrent, tests := []

   concurrent := verify_concurrent()
   
   output := open(NUL, "w") | stop("Cannot open " || NUL || " for writing")

   if *argv < 1 then {
      if /concurrent then
         write_error(3)
      put(tests, "all")
      }
   else every put(tests, !argv) 
   while test := get(tests) do {
      case test of {
         "all" : {

	    write(left("C Compiler",12)," ",left("CPU",32)," ",left("clock",12))
	    write(left(get_C_compiler(),12)," ",left(get_CPU(),32)," ",
		   left(get_clockspeed(),12))

	    write("benchmark                     CPU time h:m:s  Real time h:m:s")

            writes("concord concord.dat           ")
            tL := gettimes(run_concord, "concord.dat")
            rL := calctimes(tL[1], tL[2], tL[3], tL[4])
            writetime(rL[1], rL[2], rL[3])

            writes("deal 50000                    ")
            tL := gettimes(run_deal, 50000)
            rL := calctimes(tL[1], tL[2], tL[3], tL[4])
            writetime(rL[1], rL[2], rL[3])

            writes("ipxref ipxref.dat             ")
            tL := gettimes(run_ipxref, "ipxref.dat")
            rL := calctimes(tL[1], tL[2], tL[3], tL[4])
            writetime(rL[1], rL[2], rL[3])

            writes("queens 12                     ")
            tL := gettimes(run_queens, 12)
            rL := calctimes(tL[1], tL[2], tL[3], tL[4])
            writetime(rL[1], rL[2], rL[3])

            writes("rsg rsg.dat                   ")
            tL := gettimes(run_rsg, "rsg.dat")
            rL := calctimes(tL[1], tL[2], tL[3], tL[4])
            writetime(rL[1], rL[2], rL[3])
            
            if \concurrent then {
	       writes("binary-trees 14               ")
               tL := gettimes(run_binarytrees, 10)
               rL := calctimes(tL[1], tL[2], tL[3], tL[4])
               writetime(rL[1], rL[2], rL[3])
               }
            
            if \concurrent then {
	       writes("chameneos-redux 65000         ")
               tL := gettimes(run_chameneos, 65000)
               rL := calctimes(tL[1], tL[2], tL[3], tL[4])
               writetime(rL[1], rL[2], rL[3])
               }

            writes("fannkuch 9                    ")
            tL := gettimes(run_fannkuch, 9)
            rL := calctimes(tL[1], tL[2], tL[3], tL[4])
            writetime(rL[1], rL[2], rL[3])

            writes("fasta 250000                  ")
            tL := gettimes(run_fasta, 250000)
            rL := calctimes(tL[1], tL[2], tL[3], tL[4])
            writetime(rL[1], rL[2], rL[3])

            writes("k-nucleotide 150-thou.dat    ")
            tL := gettimes(run_knucleotide, "150-thou.dat")
            rL := calctimes(tL[1], tL[2], tL[3], tL[4])
            writetime(rL[1], rL[2], rL[3])

            if \concurrent then {
	       writes("mandelbrot 750               ")
               tL := gettimes(run_mandelbrot, 750)
               rL := calctimes(tL[1], tL[2], tL[3], tL[4])
               writetime(rL[1], rL[2], rL[3])
               }

            writes("meteor-contest 600           ")
            tL := gettimes(run_meteorcontest, 600)
            rL := calctimes(tL[1], tL[2], tL[3], tL[4])
            writetime(rL[1], rL[2], rL[3])

            writes("n-body 100000                 ")
            tL := gettimes(run_nbody, 100000)
            rL := calctimes(tL[1], tL[2], tL[3], tL[4])
            writetime(rL[1], rL[2], rL[3])

            writes("pidigits 7000                 ")
            tL := gettimes(run_pidigits, 7000)
            rL := calctimes(tL[1], tL[2], tL[3], tL[4])
            writetime(rL[1], rL[2], rL[3])

            if \concurrent then {
	       writes("regex-dna 700-thou.dat       ")
               tL := gettimes(run_regexdna, "700-thou.dat")
               rL := calctimes(tL[1], tL[2], tL[3], tL[4])
               writetime(rL[1], rL[2], rL[3])
               }

            writes("reverse-complement 15-mil.dat")
            tL := gettimes(run_reversecomplement, "15-mil.dat")
            rL := calctimes(tL[1], tL[2], tL[3], tL[4])
            writetime(rL[1], rL[2], rL[3])

            writes("spectral-norm 300             ")
            tL := gettimes(run_spectralnorm, 300)
            rL := calctimes(tL[1], tL[2], tL[3], tL[4])
            writetime(rL[1], rL[2], rL[3])

            if \concurrent then {
	       writes("thread-ring 700000           ")
               tL := gettimes(run_threadring, 700000)
               rL := calctimes(tL[1], tL[2], tL[3], tL[4])
               writetime(rL[1], rL[2], rL[3])
               }
            
            }
         "concord" : {
            write_header()
            writes("concord concord.dat           ")
            tL := gettimes(run_concord, "concord.dat")
            rL := calctimes(tL[1], tL[2], tL[3], tL[4])
            writetime(rL[1], rL[2], rL[3])
            }
         "deal" : {
            write_header()
            writes("deal 50000                    ")
            tL := gettimes(run_deal, 50000)
            rL := calctimes(tL[1], tL[2], tL[3], tL[4])
            writetime(rL[1], rL[2], rL[3])
            }
         "ipxref" : {
            write_header()
            writes("ipxref ipxref.dat             ")
            tL := gettimes(run_ipxref, "ipxref.dat")
            rL := calctimes(tL[1], tL[2], tL[3], tL[4])
            writetime(rL[1], rL[2], rL[3])
            }
         "queens" : {
            write_header()
            writes("queens 12                     ")
            tL := gettimes(run_queens, 12)
            rL := calctimes(tL[1], tL[2], tL[3], tL[4])
            writetime(rL[1], rL[2], rL[3])
            }
         "rsg" : {
            write_header()
            writes("rsg rsg.dat                   ")
            tL := gettimes(run_rsg, "rsg.dat")
            rL := calctimes(tL[1], tL[2], tL[3], tL[4])
            writetime(rL[1], rL[2], rL[3])
            }
         "binary-trees" : {
            write_header()
            writes("binary-trees 14               ")
            if \concurrent then {
               tL := gettimes(run_binarytrees, 14)
               rL := calctimes(tL[1], tL[2], tL[3], tL[4])
               writetime(rL[1], rL[2], rL[3])
               } else write_error(2)
            }
         "chameneos-redux" : {
            write_header()
            writes("chameneos-redux 65000         ")
            if \concurrent then {
               tL := gettimes(run_chameneos, 65000)
               rL := calctimes(tL[1], tL[2], tL[3], tL[4])
               writetime(rL[1], rL[2], rL[3])
               } else write_error(2)
            }
         "fannkuch" : {
            write_header()
            writes("fannkuch 9                    ")
            tL := gettimes(run_fannkuch, 9)
            rL := calctimes(tL[1], tL[2], tL[3], tL[4])
            writetime(rL[1], rL[2], rL[3])
            }
         "fasta" : {
            write_header()
            writes("fasta 250000                  ")
            tL := gettimes(run_fasta, 250000)
            rL := calctimes(tL[1], tL[2], tL[3], tL[4])
            writetime(rL[1], rL[2], rL[3])
            }
         "k-nucleotide": {
            write_header()
            writes("k-nucleotide 150-thou.dat     ")
            tL := gettimes(run_knucleotide, "150-thou.dat")
            rL := calctimes(tL[1], tL[2], tL[3], tL[4])
            writetime(rL[1], rL[2], rL[3])
            }
         "mandelbrot" : {
            write_header()
            writes("mandelbrot 750                ")
            if \concurrent then {
               tL := gettimes(run_mandelbrot, 750)
               rL := calctimes(tL[1], tL[2], tL[3], tL[4])
               writetime(rL[1], rL[2], rL[3])
               } else write_error(2)
            }
         "meteor-contest" : {
            write_header()
            writes("meteor-contest 600            ") 
            tL := gettimes(run_meteorcontest, 600)
            rL := calctimes(tL[1], tL[2], tL[3], tL[4])
            writetime(rL[1], rL[2], rL[3])
            }
         "n-body" : {
            write_header()
            writes("n-body 100000                 ")
            tL := gettimes(run_nbody, 100000)
            rL := calctimes(tL[1], tL[2], tL[3], tL[4])
            writetime(rL[1], rL[2], rL[3])
            }
         "pidigits" : {
            write_header()
            writes("pidigits 7000                 ")
            tL := gettimes(run_pidigits, 7000)
            rL := calctimes(tL[1], tL[2], tL[3], tL[4])
            writetime(rL[1], rL[2], rL[3])
            }
         "regex-dna" : {
            write_header()
            writes("regex-dna 700-thou.dat        ")
            if \concurrent then {
               tL := gettimes(run_regexdna, "700-thou.dat")
               rL := calctimes(tL[1], tL[2], tL[3], tL[4])
               writetime(rL[1], rL[2], rL[3])
               } else write_error(2)
            }
         "reverse-complement" : {
            write_header()
            writes("reverse-complement 15-mil.dat ")
            tL := gettimes(run_reversecomplement, "15-mil.dat")
            rL := calctimes(tL[1], tL[2], tL[3], tL[4])
            writetime(rL[1], rL[2], rL[3])
            }
         "spectral-norm" : {
            write_header()
            writes("spectral-norm 300             ")
            tL := gettimes(run_spectralnorm, 300)
            rL := calctimes(tL[1], tL[2], tL[3], tL[4])
            writetime(rL[1], rL[2], rL[3])
            }
         "thread-ring" : {
            write_header()
            writes("thread-ring 700000            ")
            if \concurrent then {
               tL := gettimes(run_threadring, 700000)
               rL := calctimes(tL[1], tL[2], tL[3], tL[4])
               writetime(rL[1], rL[2], rL[3])
               } else write_error(2)
            }
         default : write("\ncannot run benchmark " || test || "\n")
         }
      }
end
